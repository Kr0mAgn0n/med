dojo.require("esri.dijit.Measurement");dojo.require("esri.dijit.Scalebar");dojo.require("esri.map");dojo.require("agsjs.layers.GoogleMapsLayer");dojo.require("agsjs.dijit.TOC");dojo.require("dojo.fx");dojo.require("esri.dijit.OverviewMap");dojo.require("esri.layers.FeatureLayer");dojo.require("esri.tasks.query");dojo.require("dojox.grid.EnhancedGrid");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("esri.dijit.Print");dojo.require("dijit.Toolbar");dojo.require("esri.toolbars.draw");dojo.require("esri.toolbars.Navigation");var map;var currentBasemap;var identifyTask,identifyParams;var store,grid,datos;var initExtent;function init(){initExtent=new esri.geometry.Extent({xmin:-9052049.2735,ymin:-2078120.579,xmax:-7643108.7015,ymax:-10153.778299998492,spatialReference:{wkid:102100}});map=new esri.Map("map",{extent:initExtent,wrapAround180:true,sliderStyle:"small",logo:false,});dojo.connect(map,"onUpdateStart",function(){activarCargando()});dojo.connect(map,"onUpdateEnd",function(){desactivarCargando()});createBasemapGallery();centros_poblados=new esri.layers.ArcGISDynamicMapServiceLayer("http://escale.minedu.gob.pe/medgis/rest/services/carto_base/cp/MapServer");map.addLayer(centros_poblados);limites_politicos=new esri.layers.ArcGISTiledMapServiceLayer("http://escale.minedu.gob.pe/medgis/rest/services/carto_base/pol/MapServer");ie=new esri.layers.ArcGISDynamicMapServiceLayer("http://escale.minedu.gob.pe/medgis/rest/services/carto_base/ie/MapServer");var c=new agsjs.dijit.TOC({map:map,layerInfos:[{layer:centros_poblados,title:"Centros Poblados"},{layer:limites_politicos,title:"Límites Políticos"},{layer:ie,title:"Instituciones Educativas"}]},"toc");c.startup();osml=new esri.layers.OpenStreetMapLayer();var d=new esri.dijit.OverviewMap({map:map,baseLayer:osml,height:0.25*map.height,width:0.25*map.width});d.startup();llenarFormulario();dojo.connect(dojo.byId("buscar"),"onclick",busqueda);dojo.connect(window,"onresize",function(){if(map){map.resize()}});datos={items:[]};grid=new dojox.grid.EnhancedGrid({},dojo.create("div",{},dojo.byId("fm_results")));grid.startup();dojo.connect(window,"onresize",function(){grid.resize();grid.update()});dojo.connect(grid,"onRowClick",function(b){map.graphics.clear();aux=grid.getItem(b.rowIndex).longitud[0].split(" ");aux2=grid.getItem(b.rowIndex).latitud[0].split(" ");point=new esri.geometry.Point(aux[1],aux2[1],new esri.SpatialReference({wkid:5373}));point=esri.geometry.geographicToWebMercator(point);var a=new esri.Graphic(point,new esri.symbol.PictureMarkerSymbol("images/i_target.png",38,38));map.graphics.add(a);map.centerAndZoom(point,14)});printer=new esri.dijit.Print({map:map,templates:[{label:"Map",format:"PDF",layout:"MAP_ONLY",exportOptions:{width:500,height:400,dpi:96}},{label:"Layout",format:"PDF",layout:"A4 Portrait",layoutOptions:{titleText:"My Print",authorText:"esri",copyrightText:"My Company",scalebarUnit:"Miles",}}],url:"http://escale.minedu.gob.pe/medgis/rest/services/Utilities/PrintingTools/GPServer/Export Web Map Task"},dojo.byId("printer"));printer.startup();iniciarIdentify();iniciarNavegacion();onMapLoaded();desactivarCargando();dojo.style("cargando","opacity",0.5)}function createBasemapGallery(){var c=[];c.push(new esri.dijit.Basemap({layers:[new esri.dijit.BasemapLayer({type:"GoogleMapsRoad"})],title:"Google Road",id:"GoogleRoad",thumbnailUrl:dojo.moduleUrl("agsjs.dijit","images/googleroad.png")}));c.push(new esri.dijit.Basemap({layers:[new esri.dijit.BasemapLayer({type:"GoogleMapsSatellite"})],title:"Google Satellite",id:"GoogleSatellite",thumbnailUrl:dojo.moduleUrl("agsjs.dijit","images/googlesatellite.png")}));c.push(new esri.dijit.Basemap({layers:[new esri.dijit.BasemapLayer({type:"GoogleMapsHybrid"})],title:"Google Hybrid",id:"GoogleHybrid",thumbnailUrl:dojo.moduleUrl("agsjs.dijit","images/googlehybrid.png")}));c.push(new esri.dijit.Basemap({layers:[new esri.dijit.BasemapLayer({type:"OpenStreetMap"})],title:"OpenStreet",id:"OpenStreetMap",thumbnailUrl:"images/bm-street.jpg"}));var d=new esri.dijit.BasemapGallery({showArcGISBasemaps:false,basemaps:c,google:{apiOptions:{v:"3.6"},mapOptions:{streetViewControl:false}},map:map},"basemapList");d.startup();d.select("GoogleHybrid");dojo.connect(d,"onError",function(a){if(console){console.log(a)}})}function onMapLoaded(){console.log("map loaded enter");var c=new esri.dijit.Scalebar({map:map,attachTo:"bottom-left",scalebarUnit:"metric"});var d=new esri.dijit.Measurement({map:map},dojo.byId("measurementDiv"));d.startup();dojo.connect(map,"onMouseMove",res.showCoords);res.showCoords(map.extent.getCenter());dojo.connect(map,"onExtentChange",onMapExtentChange);onMapExtentChange();console.log("map loaded exit")}function onMapExtentChange(){var b=Math.round(esri.geometry.getScale(map));if(b>999&&b<=999999){b=Math.round(b/1000)+" <b>K</b>"}else{if(b>999999){b=Math.round(b/1000000)+" <b>M</b>"}else{if(b>0&&b<=999){b=Math.round(b)+" <b>Ft</b>"}}}res.updateScaleInfo(b,map.getLevel())}function activarCargando(){dojo.style("cargando","display","block")}function desactivarCargando(){dojo.style("cargando","display","none")}window.onorientationchange=function(){if(map){map.resize()}else{console.log("map not found")}};window.onresize=function(){if(map){map.resize()}else{console.log("map not found")}};dojo.ready(init);