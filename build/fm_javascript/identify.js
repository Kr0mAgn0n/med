var punto,multipunto,mano_alzada,extension;var drawToolbar;function iniciarIdentify(){drawToolbar=new esri.toolbars.Draw(map);punto=new dijit.form.ToggleButton({iconClass:"identifyPuntoIcon",label:"Punto"},dojo.byId("punto"));mano_alzada=new dijit.form.ToggleButton({iconClass:"identifyFreeHandIcon",label:"Mano Alzada"},dojo.byId("mano-alzada"));extension=new dijit.form.ToggleButton({iconClass:"identifyExtentIcon",label:"Extensión"},dojo.byId("extension"));dojo.connect(punto,"onClick",function(){if(punto.checked==true){mano_alzada.setChecked(false);extension.setChecked(false);drawToolbar.activate(esri.toolbars.Draw.POINT)}else{drawToolbar.deactivate()}});dojo.connect(mano_alzada,"onClick",function(){if(mano_alzada.checked==true){punto.setChecked(false);extension.setChecked(false);drawToolbar.activate(esri.toolbars.Draw.FREEHAND_POLYGON)}else{drawToolbar.deactivate()}});dojo.connect(extension,"onClick",function(){if(extension.checked==true){punto.setChecked(false);mano_alzada.setChecked(false);drawToolbar.activate(esri.toolbars.Draw.EXTENT)}else{drawToolbar.deactivate()}});dojo.connect(drawToolbar,"onDrawEnd",manejadorDrawEnd)}function manejadorDrawEnd(a){map.graphics.clear();graphic=new esri.Graphic(a,new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([255,0,0]),2),new dojo.Color([255,255,0,0.5])));map.graphics.add(graphic);activarCargando();identifyTask=new esri.tasks.IdentifyTask("http://escale.minedu.gob.pe/medgis/rest/services/carto_base/cp_ie/MapServer");identifyParams=new esri.tasks.IdentifyParameters();identifyParams.geometry=a;identifyParams.tolerance=3;identifyParams.returnGeometry=false;identifyParams.width=map.width;identifyParams.height=map.height;identifyParams.mapExtent=map.extent;identifyParams.layerOption=esri.tasks.IdentifyParameters.LAYER_OPTION_VISIBLE;identifyParams.layersIds=[4];identifyTask.execute(identifyParams,identifyCallbackCP,identifyError)}function identifyCallbackCP(a){datos={items:[]};datosExporter={items:[]};layout=[[{name:"Ubigeo",field:"ubigeo"}],[{name:"Nombre del Centro Poblado",field:"nombre_del_centro_poblado"}],[{name:"Código del Centro Poblado",field:"codigo_del_centro_poblado"}],[{name:"Con Institución Educativa",field:"con_ie"}],[{name:"Fuente",field:"fuente_g"}],[{name:"Altitud",field:"altitud"}],[{name:"Latitud",field:"latitud",hidden:true}],[{name:"Longitud",field:"longitud",hidden:true}],[{name:"Enlaces",field:"enlaces"}]];layoutExporter=[[{name:"Ubigeo",field:"ubigeo"}],[{name:"Nombre del Centro Poblado",field:"nombre_del_centro_poblado"}],[{name:"Código del Centro Poblado",field:"codigo_del_centro_poblado"}],[{name:"Con Institución Educativa",field:"con_ie"}],[{name:"Fuente",field:"fuente_g"}],[{name:"Altitud",field:"altitud"}],[{name:"Latitud",field:"latitud"}],[{name:"Longitud",field:"longitud"}]];dojo.forEach(a,function(b){items={ubigeo:"Ubigeo: "+b.feature.attributes.UBIGEO,codigo_del_centro_poblado:"Código del Centro Poblado: "+b.feature.attributes.CODCP,nombre_del_centro_poblado:"Nombre del Centro Poblado: "+b.feature.attributes.NOMCP,con_ie:"¿Tiene IE?: "+b.feature.attributes.CON_IE,fuente_g:"Fuente: "+b.feature.attributes.FUENTE_G,altitud:"Altitud: "+b.feature.attributes.Z,latitud:"Latitud: "+b.feature.attributes.YGD,longitud:"Longitud: "+b.feature.attributes.XGD,enlaces:"<a class='img-enlaces' onclick='hacerZoom("+b.feature.attributes.XGD+","+b.feature.attributes.YGD+");'><img src='images/zoom.png'></a><a class='img-enlaces' onclick='irAIE("+b.feature.attributes.CODCP+")'><img src='images/ficha.png'></a>"};itemsExporter={ubigeo:b.feature.attributes.UBIGEO,codigo_del_centro_poblado:b.feature.attributes.CODCP,nombre_del_centro_poblado:b.feature.attributes.NOMCP,con_ie:b.feature.attributes.CON_IE,fuente_g:b.feature.attributes.FUENTE_G,altitud:b.feature.attributes.Z,latitud:b.feature.attributes.YGD,longitud:b.feature.attributes.XGD};datos.items.push(items);datosExporter.items.push(itemsExporter)});store=new dojo.data.ItemFileWriteStore({data:datos});grid.onStyleRow=styleRowIdentify;grid.setStructure(layout);grid.setStore(store);storeExporter=new dojo.data.ItemFileWriteStore({data:datosExporter});gridExporter.setStructure(layoutExporter);gridExporter.setStore(storeExporter);gridMemory.memory.push({store:store,storeExporter:storeExporter,layout:layout,layoutExporter:layoutExporter,type:"identify"});gridMemory.selectedIndex=gridMemory.memory.length-1;dojo.query(".fm_button").removeClass("fm_button_active");dojo.query(".fm_results_trigger").addClass("fm_button_active");dojo.query(".fm_panel").style("display","none");dojo.query(".fm_results").style("display","block");desactivarCargando()}function identifyCallbackIE(a){datos={items:[]};layout=[[{name:"Ubigeo",field:"ubigeo"}],[{name:"Departamento",field:"departamento"}],[{name:"Provincia",field:"provincia"}],[{name:"Distrito",field:"distrito"}],[{name:"Nombre del Centro Poblado",field:"nombre_del_centro_poblado"}],[{name:"Código del Centro Poblado",field:"codigo_del_centro_poblado"}],[{name:"Localidad",field:"localidad"}],[{name:"Código Local",field:"codigo_local"}],[{name:"Código Modular",field:"codigo_modular"}],[{name:"Nombre IE",field:"nombre_ie"}],[{name:"Nivel",field:"nivel"}],[{name:"Altitud",field:"altitud"}],[{name:"Fuente CP",field:"fuente_cp"}],[{name:"Latitud",field:"latitud",hidden:true}],[{name:"Longitud",field:"longitud",hidden:true}],[{name:"Enlaces",field:"enlaces"}]];datosExporter={items:[]};layoutExporter=[[{name:"Ubigeo",field:"ubigeo"},{name:"Departamento",field:"departamento"},{name:"Provincia",field:"provincia"},{name:"Distrito",field:"distrito"},{name:"Nombre del Centro Poblado",field:"nombre_del_centro_poblado"},{name:"Código del Centro Poblado",field:"codigo_del_centro_poblado"},{name:"Localidad",field:"localidad"},{name:"Código Local",field:"codigo_local"},{name:"Código Modular",field:"codigo_modular"},{name:"Nombre IE",field:"nombre_ie"},{name:"Nivel",field:"nivel"},{name:"Altitud",field:"altitud"},{name:"Fuente CP",field:"fuente_cp"},{name:"Latitud",field:"latitud"},{name:"Longitud",field:"longitud"}]];dojo.forEach(a,function(b){items={codigo_ugel:b.feature.attributes.CODOOII,centro_poblado:b.feature.attributes.ciudad,centro_educativo:b.feature.attributes.CEN_EDU,estado:b.feature.attributes.ESTADO,gestion:b.feature.attributes.GESTION,niveles:b.feature.attributes.NIVELES,fuente:b.feature.attributes.FUENTE,latitud:b.feature.attributes.POINT_Y,longitud:b.feature.attributes.POINT_X,enlaces:"<a class='img-enlaces' onclick='hacerZoom("+b.feature.attributes.POINT_X+","+b.feature.attributes.POINT_Y+");'><img src='images/zoom.png'></a><a class='img-enlaces' onclick='irAFicha("+b.feature.attributes.CODCP+")'><img src='images/ficha.png'></a>"};itemsExporter={codigo_ugel:b.feature.attributes.CODOOII,centro_poblado:b.feature.attributes.ciudad,centro_educativo:b.feature.attributes.CEN_EDU,estado:b.feature.attributes.ESTADO,gestion:b.feature.attributes.GESTION,niveles:b.feature.attributes.NIVELES,fuente:b.feature.attributes.FUENTE,latitud:b.feature.attributes.POINT_Y,longitud:b.feature.attributes.POINT_X};datos.items.push(items);datosExporter.items.push(itemsExporter)});store=new dojo.data.ItemFileWriteStore({data:datos});grid.onStyleRow=styleRowIdentify;grid.setStructure(layout);grid.setStore(store);storeExporter=new dojo.data.ItemFileWriteStore({data:datosExporter});gridExporter.setStructure(layoutExporter);gridExporter.setStore(storeExporter);gridMemory.memory.push({store:store,storeExporter:storeExporter,layout:layout,layoutExporter:layoutExporter,type:"identify"});gridMemory.selectedIndex=gridMemory.memory.length-1;dojo.query(".fm_button").removeClass("fm_button_active");dojo.query(".fm_results_trigger").addClass("fm_button_active");dojo.query(".fm_panel").style("display","none");dojo.query(".fm_results").style("display","block");desactivarCargando()}function identifyError(a){desactivarCargando();alert("La consulta no pudo ser hecha. "+a)}function styleRowIdentify(a){console.log(a);if(a.index%2!==0){a.customStyles+="background: #D7EB66;"}if(a.over){a.customStyles+="background: #7FC5EB"}};